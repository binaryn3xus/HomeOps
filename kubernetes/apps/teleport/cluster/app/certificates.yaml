---
# ============================================================================
# Teleport Certificate Authority & Trust Infrastructure
# ============================================================================
# This file consolidates the trust chain for Teleport:
# 1. Intermediary CA: Root of trust for internal cluster communications
# 2. Public Cert: Secured via Let's Encrypt for user/browser access
# 3. Internal Cert: Secured via Intermediary CA for intra-cluster communication
# ============================================================================

# ----------------------------------------------------------------------------
# 1. Intermediary CA
# Generates a long-lived internal CA signed by the cluster's Root CA.
# This prevents split-brain trust issues for internal services.
# ----------------------------------------------------------------------------
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: teleport-intermediary-ca
  namespace: teleport
spec:
  isCA: true
  commonName: "HomeOps Intermediary CA"
  duration: 87600h # 10 years
  secretName: teleport-intermediary-ca-secret
  issuerRef:
    name: root-ca-issuer
    kind: ClusterIssuer
    group: cert-manager.io
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: teleport-intermediary-ca-issuer
  namespace: teleport
spec:
  ca:
    secretName: teleport-intermediary-ca-secret

# ----------------------------------------------------------------------------
# 2. Public Certificate (External Access)
# Trusted by browsers (Chrome, Edge, etc) via Let's Encrypt.
# Used by the Proxy for incoming user connections.
# ----------------------------------------------------------------------------
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: teleport-proxy-public-cert
  namespace: teleport
spec:
  commonName: teleport.unscfleet.com
  dnsNames:
    - teleport.unscfleet.com
    - "*.teleport.unscfleet.com"
  subject:
    countries: ["US"]
    organizations: ["binaryn3xus-homeops"]
    provinces: ["NC"]
  issuerRef:
    group: cert-manager.io
    kind: ClusterIssuer
    name: letsencrypt-production
  secretName: teleport-proxy-public-cert

# ----------------------------------------------------------------------------
# 3. Internal Certificate (Cluster Access)
# Trusted by Teleport Agents via the Intermediary CA.
# Used for internal gRPC communication between Proxy and Agents.
# ----------------------------------------------------------------------------
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: teleport-proxy-internal-cert
  namespace: teleport
spec:
  commonName: teleport.teleport.svc.cluster.local
  dnsNames:
    - teleport.teleport.svc.cluster.local
    - "*.teleport.teleport.svc.cluster.local"
    - teleport.teleport.svc
    - "*.teleport.teleport.svc"
  subject:
    countries: ["US"]
    organizations: ["binaryn3xus-homeops"]
    provinces: ["NC"]
  issuerRef:
    group: cert-manager.io
    kind: Issuer
    name: teleport-intermediary-ca-issuer
  secretName: teleport-proxy-internal-cert

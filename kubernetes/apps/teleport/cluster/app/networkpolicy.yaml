---
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: teleport-cluster-policy
  namespace: teleport
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/instance: teleport-cluster

  egress:
    # Rule 1: Allow DNS lookups to CoreDNS in the kube-system namespace.
    # This will fix the "i/o timeout" on port 53.
    - toEndpoints:
        - matchLabels:
            "k8s:io.kubernetes.pod.namespace": kube-system
            "k8s:k8s-app": kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
          rules:
            dns:
              - matchPattern: "*"

    # Rule 2: Allow the operator and proxy to talk to the auth service.
    # This will fix the "connection timed out" on port 3025.
    - toServices:
        - k8sService:
            serviceName: teleport-cluster-auth
            namespace: teleport

    # Rule 3: Allow connection to the Kubernetes API server.
    - toEntities:
        - kube-apiserver

  ingress:
    # Rule 1: Allow ingress to the auth service from other Teleport pods
    - fromEndpoints:
      - matchLabels:
          app.kubernetes.io/instance: teleport-cluster
